/*! AeroGear JavaScript Library - v2.1.0 - 2015-03-12
* https://github.com/aerogear/aerogear-js
* JBoss, Home of Professional Open Source
* Copyright Red Hat, Inc., and individual contributors
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
* http://www.apache.org/licenses/LICENSE-2.0
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
!function(a,b){this.AeroGear={},AeroGear.Core=function(){if(this instanceof AeroGear.Core)throw"Invalid instantiation of base class AeroGear.Core";this.add=function(a){var b,c,d=this[this.collectionName]||{};if(this[this.collectionName]=d,!a)return this;if("string"==typeof a)d[a]=AeroGear[this.lib].adapters[this.type](a,this.config);else if(Array.isArray(a))for(b=0;b<a.length;b++)c=a[b],"string"==typeof c?d[c]=AeroGear[this.lib].adapters[this.type](c,this.config):c.name&&(c.settings=AeroGear.extend(c.settings||{},this.config),d[c.name]=AeroGear[this.lib].adapters[c.type||this.type](c.name,c.settings));else{if(!a.name)return this;a.settings=AeroGear.extend(a.settings||{},this.config),d[a.name]=AeroGear[this.lib].adapters[a.type||this.type](a.name,a.settings)}return this[this.collectionName]=d,this},this.remove=function(a){var b,c,d=this[this.collectionName]||{};if("string"==typeof a)delete d[a];else if(Array.isArray(a))for(b=0;b<a.length;b++)c=a[b],"string"==typeof c?delete d[c]:delete d[c.name];else a&&delete d[a.name];return this[this.collectionName]=d,this}},AeroGear.extend=function(){var a,b,c,d=arguments[0];for(b=1;b<arguments.length;b++){c=arguments[b];for(a in c)d[a]=c[a]}return d},AeroGear.DiffSyncEngine=function(a){return this instanceof AeroGear.DiffSyncEngine?(this.lib="DiffSyncEngine",this.type=a?a.type||"jsonPatch":"jsonPatch",new AeroGear.DiffSyncEngine.adapters[this.type]):new AeroGear.DiffSyncEngine(a)},AeroGear.DiffSyncEngine.adapters={},AeroGear.DiffSyncEngine.adapters.diffMatchPatch=function(){if(!(this instanceof AeroGear.DiffSyncEngine.adapters.diffMatchPatch))return new AeroGear.DiffSyncEngine.adapters.diffMatchPatch;var a={docs:[],shadows:[],backups:[],edits:[]},b=new diff_match_patch;this.addDocument=function(a){this._saveDocument(JSON.parse(JSON.stringify(a))),this._saveShadow(JSON.parse(JSON.stringify(a))),this._saveShadowBackup(JSON.parse(JSON.stringify(a)),0)},this.diff=function(a){var c,d,e,f,g=this._readData(a.id,"shadows")[0];return"string"==typeof a.content?(d=a.content,e=g.content):(d=JSON.stringify(a.content),e=JSON.stringify(g.content)),c={msgType:"patch",id:a.id,clientId:g.clientId,edits:[{clientVersion:g.clientVersion,serverVersion:g.serverVersion,checksum:"",diffs:this._asAeroGearDiffs(b.diff_main(e,d))}]},g.clientVersion++,g.content=a.content,this._saveShadow(JSON.parse(JSON.stringify(g))),f=this._getEdits(a.id),f&&f.length>0&&(c.edits=f.concat(c.edits)),c},this.patch=function(a){var b=this.patchShadow(a);this.patchDocument(b),this._saveShadowBackup(b,b.clientVersion)},this._asAeroGearDiffs=function(a){return a.map(function(a){return{operation:this._asAgOperation(a[0]),text:a[1]}}.bind(this))},this._asDiffMatchPathDiffs=function(a){return a.map(function(a){return[this._asDmpOperation(a.operation),a.text]}.bind(this))},this._asDmpOperation=function(a){return"DELETE"===a?-1:"ADD"===a?1:0},this._asAgOperation=function(a){return-1===a?"DELETE":1===a?"ADD":"UNCHANGED"},this.patchShadow=function(a){var b,c,d=this.getShadow(a.id),e=a.edits;for(b=0;b<e.length;b++)c=e[b],c.clientVersion<d.clientVersion&&!this._isSeeded(c)?d=this._restoreBackup(d,c):c.serverVersion<d.serverVersion?this._removeEdit(a.id,c):(c.serverVersion===d.serverVersion&&c.clientVersion===d.clientVersion||this._isSeeded(c))&&(this.applyEditsToShadow(c,d),this._isSeeded(c)?d.clientVersion=0:c.clientVersion>=0&&d.serverVersion++,this._saveShadow(d),this._removeEdit(a.id,c));return d},this._isSeeded=function(a){return-1===a.clientVersion},this.applyEditsToShadow=function(a,c){var d,e,f,g;d="string"==typeof c.content?c.content:JSON.stringify(c.content),e=this._asDiffMatchPathDiffs(a.diffs),f=b.patch_make(d,e),g=b.patch_apply(f,d);try{c.content=JSON.parse(g[0])}catch(h){c.content=g[0]}return c},this.patchDocument=function(a){var c,d,e,f;return c=this.getDocument(a.id),d=b.diff_main(JSON.stringify(c.content),JSON.stringify(a.content)),e=b.patch_make(JSON.stringify(c.content),d),f=b.patch_apply(e,JSON.stringify(c.content)),c.content=JSON.parse(f[0]),this._saveDocument(c),f},this._saveData=function(b,c){b=Array.isArray(b)?b:[b],a[c]=b},this._readData=function(b,c){return a[c].filter(function(a){return a.id===b})},this._saveDocument=function(a){return this._saveData(a,"docs"),a},this._saveShadow=function(a){var b={id:a.id,serverVersion:a.serverVersion||0,clientId:a.clientId,clientVersion:a.clientVersion||0,content:a.content};return this._saveData(b,"shadows"),b},this._saveShadowBackup=function(a,b){var c={id:a.id,clientVersion:b,content:a.content};return this._saveData(c,"backups"),c},this.getDocument=function(a){return this._readData(a,"docs")[0]},this.getShadow=function(a){return this._readData(a,"shadows")[0]},this.getBackup=function(a){return this._readData(a,"backups")[0]},this._saveEdits=function(a){var b={id:a.id,clientId:a.clientId,edits:a.edits};return this._saveData(b,"edits"),b},this._getEdits=function(a){var b=this._readData(a,"edits");return b.length?b.edits:[]},this._removeEdit=function(a,b){var c,d,e,f=this._readData(a,"edits");for(c=0;c<f.length;c++)for(e=f[c],d=0;d<e.edits.length;d++)if(e.edits[d].serverVersion===b.serverVersion&&e.edits[d].clientVersion<=b.clientVersion){e.edits.splice(c,1);break}},this._removeEdits=function(a){var b=this._readData(a,"edits");b.splice(0,b.length)},this._restoreBackup=function(a,b){var c,d,e=this.getBackup(a.id);if(b.clientVersion===e.clientVersion)return d={id:e.id,clientVersion:e.clientVersion,content:e.content},c=this.applyEditsToShadow(b,d),d.serverVersion++,this._removeEdits(a.id),this._saveShadow(c);throw"Edit's clientVersion '"+b.clientVersion+"' does not match the backups clientVersion '"+e.clientVersion+"'"}},AeroGear.DiffSyncEngine.adapters.jsonPatch=function(){if(!(this instanceof AeroGear.DiffSyncEngine.adapters.jsonPatch))return new AeroGear.DiffSyncEngine.adapters.jsonPatch;var a={docs:[],shadows:[],backups:[],edits:[]};this.addDocument=function(a){this._saveDocument(JSON.parse(JSON.stringify(a))),this._saveShadow(JSON.parse(JSON.stringify(a))),this._saveShadowBackup(JSON.parse(JSON.stringify(a)),0)},this.diff=function(a){var b,c,d=this._readData(a.id,"shadows")[0];return b={msgType:"patch",id:a.id,clientId:d.clientId,edits:[{clientVersion:d.clientVersion,serverVersion:d.serverVersion,checksum:"",diffs:jsonpatch.compare(d.content,a.content)}]},d.clientVersion++,d.content=a.content,this._saveShadow(JSON.parse(JSON.stringify(d))),c=this._getEdits(a.id),c&&c.length>0&&(b.edits=c.concat(b.edits)),b},this.patch=function(a){var b=this.patchShadow(a);this.patchDocument(b),this._saveShadowBackup(b,b.clientVersion)},this.patchShadow=function(a){var b,c,d=this.getShadow(a.id),e=a.edits;for(b=0;b<e.length;b++)c=e[b],c.clientVersion<d.clientVersion&&!this._isSeeded(c)?d=this._restoreBackup(d,c):c.serverVersion<d.serverVersion?this._removeEdit(a.id,c):(c.serverVersion===d.serverVersion&&c.clientVersion===d.clientVersion||this._isSeeded(c))&&(this.applyEditsToShadow(c,d),this._isSeeded(c)?d.clientVersion=0:c.clientVersion>=0&&d.serverVersion++,this._saveShadow(d),this._removeEdit(a.id,c));return d},this._isSeeded=function(a){return-1===a.clientVersion},this.applyEditsToShadow=function(a,b){var c;return c=jsonpatch.apply(b.content,a.diffs),b},this.patchDocument=function(a){var b,c,d;return b=this.getDocument(a.id),c=jsonpatch.compare(b.content,a.content),d=jsonpatch.apply(b.content,c),this._saveDocument(b),d},this._saveData=function(b,c){b=Array.isArray(b)?b:[b],a[c]=b},this._readData=function(b,c){return a[c].filter(function(a){return a.id===b})},this._saveDocument=function(a){return this._saveData(a,"docs"),a},this._saveShadow=function(a){var b={id:a.id,serverVersion:a.serverVersion||0,clientId:a.clientId,clientVersion:a.clientVersion||0,content:a.content};return this._saveData(b,"shadows"),b},this._saveShadowBackup=function(a,b){var c={id:a.id,clientVersion:b,content:a.content};return this._saveData(c,"backups"),c},this.getDocument=function(a){return this._readData(a,"docs")[0]},this.getShadow=function(a){return this._readData(a,"shadows")[0]},this.getBackup=function(a){return this._readData(a,"backups")[0]},this._saveEdits=function(a){var b={id:a.id,clientId:a.clientId,edits:a.edits};return this._saveData(b,"edits"),b},this._getEdits=function(a){var b=this._readData(a,"edits");return b.length?b.edits:[]},this._removeEdit=function(a,b){var c,d,e,f=this._readData(a,"edits");for(c=0;c<f.length;c++)for(e=f[c],d=0;d<e.edits.length;d++)if(e.edits[d].clientVersion<=b.clientVersion){e.edits.splice(c,1);break}},this._removeEdits=function(a){var b=this._readData(a,"edits");b.splice(0,b.length)},this._restoreBackup=function(a,b){var c,d,e=this.getBackup(a.id);if(b.clientVersion===e.clientVersion)return d={id:e.id,clientVersion:e.clientVersion,content:e.content},c=this.applyEditsToShadow(b,d),d.serverVersion++,this._removeEdits(a.id),this._saveShadow(c);throw"Edit's clientVersion '"+b.clientVersion+"' does not match the backups clientVersion '"+e.clientVersion+"'"}},AeroGear.DiffSyncClient=function(a){if(!(this instanceof AeroGear.DiffSyncClient))return new AeroGear.DiffSyncClient(a);a=a||{};var c,d=[],e=this,f=a.syncEngine||new AeroGear.DiffSyncEngine;if(a.serverUrl===b)throw new Error("'config.serverUrl' must be specified");this.connect=function(){c=new WebSocket(a.serverUrl),c.onopen=function(){for(a.onopen&&a.onopen.apply(this,arguments);d.length;){var b=d.pop();"add"===b.type?g(b.type,b.msg):e.sendEdits(b.msg)}},c.onmessage=function(b){var c,d;try{c=JSON.parse(b.data)}catch(f){c={}}c&&e._patch(c),d=e.getDocument(c.id),a.onsync&&a.onsync.call(this,d,b)},c.onerror=function(){a.onerror&&a.onerror.apply(this,arguments)},c.onclose=function(){a.onclose&&a.onclose.apply(this,arguments)}},this.connect(),this.disconnect=function(){c.close()},this._patch=function(a){f.patch(a)},this.getDocument=function(a){return f.getDocument(a)},this._diff=function(a){return f.diff(a)},this.addDocument=function(a){f.addDocument(a),0===c.readyState?d.push({type:"add",msg:a}):1===c.readyState&&g("add",a)},this._sendEdits=function(a){if(c.readyState===WebSocket.OPEN)c.send(JSON.stringify(a));else if(0===d.length)d.push({type:"patch",msg:a});else{for(var b=!1,e=0;e<d.length;e++){var f=d[e];if("patch"===f.type&&f.msg.clientId===a.clientId&&f.msg.id===a.id){for(var g=0;g<a.edits.length;g++)f.msg.edits.push(a.edits[g]);b=!0}}b||d.push({type:"patch",msg:a})}},this.sync=function(a){var b=e._diff(a);e._sendEdits(b)},this.removeDoc=function(){throw new Error("Method Not Yet Implemented")},this.fetch=function(a){var b,c;if(0===d.length)b=f.getDocument(a),e.sync(b);else for(;d.length;)c=d.shift(),"add"===c.type?g(c.type,c.msg):e._sendEdits(c.msg)};var g=function(a,b){var d={msgType:a,id:b.id,clientId:b.clientId,content:b.content};c.send(JSON.stringify(d))}}}(this);
//# sourceMappingURL=aerogear.custom.min.js.map